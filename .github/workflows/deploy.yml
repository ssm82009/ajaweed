name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build

      - name: Deploy Files via SSH
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          # We only copy the necessary production files
          source: "dist/*,server/*,package.json,package-lock.json,startup.cjs,app.js"
          target: "/home/ajaweed/ajaweed_app"
          strip_components: 0

      - name: Post-Deploy Tasks (Create .env, Install Deps & Restart)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            cd /home/ajaweed/ajaweed_app
            
            # Create/Update .env file from secrets
            echo "TURSO_URL=${{ secrets.TURSO_URL }}" > .env
            echo "TURSO_AUTH_TOKEN=${{ secrets.TURSO_AUTH_TOKEN }}" >> .env
            
            # Install production dependencies only
            npm ci --production
            
            # Restart Application
            mkdir -p tmp
            touch tmp/restart.txt
            
            echo "Deployment Complete and App Restarted with Turso Config"
